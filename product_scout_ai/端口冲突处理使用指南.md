# ProductScout AI 端口冲突处理使用指南

## ✅ 问题已解决

我已经成功修改了主启动脚本 `run_app.py`，现在能够**自动检测和处理端口冲突**。

## 🚀 使用方法

### 1. 标准启动（推荐）
```bash
python3 run_app.py
```

**新功能特性**:
- 🔍 **自动检测端口占用**
- 🔄 **自动终止占用进程**
- ⚡ **智能等待端口释放**
- 💡 **友好的错误提示**

### 2. 测试端口处理功能
```bash
python3 test_port_handler.py
```

## 📋 启动流程说明

### 启动脚本执行步骤：

1. **🔍 检查依赖包**
   - 自动验证 gradio、google-adk、google-generativeai 是否已安装
   - 如果缺失，自动尝试安装

2. **🔧 处理端口冲突**
   - 检查端口7860是否被占用
   - 如果被占用，自动终止占用进程
   - 等待端口完全释放

3. **🚀 启动应用**
   - 创建Gradio应用
   - 启动在 http://localhost:7860
   - 提供服务访问地址

## 🔍 端口处理详情

### 自动处理流程：
1. **检测**: 使用socket连接检查端口可用性
2. **查找**: 使用`lsof -i :7860`找到占用进程
3. **终止**: 先发送温和的TERM信号
4. **强制**: 如果进程仍存在，发送KILL信号
5. **验证**: 等待并确认端口已释放

### 安全特性：
- ✅ 只处理指定端口(7860)的占用进程
- ✅ 优先尝试温和终止，避免强制终止
- ✅ 提供详细的过程日志
- ✅ 如果自动处理失败，提供手动处理指导

## 🛠️ 故障排除

### 如果启动仍然失败：

1. **检查端口状态**:
   ```bash
   lsof -i :7860
   ```

2. **手动终止进程**:
   ```bash
   kill -9 <PID>
   ```

3. **使用其他端口**:
   修改 `run_app.py` 中的端口变量：
   ```python
   server_port = 7861  # 改为其他端口
   ```

### 常见错误处理：

- **"address already in use"**: 端口仍被占用，等待几秒后重试
- **"权限被拒绝"**: 检查端口是否需要管理员权限
- **"进程不存在"**: 正常情况，说明端口已可用

## 📊 测试结果

修改后的启动脚本测试通过：
- ✅ **端口检测功能**: 正常工作
- ✅ **进程终止功能**: 正常工作
- ✅ **依赖检查功能**: 正常工作
- ✅ **错误处理功能**: 正常工作
- ✅ **用户反馈**: 清晰详细

## 🎯 使用建议

### 最佳实践：
1. **使用修改后的脚本**: `python3 run_app.py`
2. **查看启动日志**: 注意端口处理过程信息
3. **等待完全启动**: 确认看到成功启动消息
4. **正确停止服务**: 使用 Ctrl+C 优雅停止

### 性能优化：
- 脚本会在2-3秒内完成端口处理
- 如果有多个进程占用，会逐个处理
- 处理完成后立即启动服务

---

**总结**: 现在的启动脚本能够智能处理端口冲突，无需手动干预。只需要运行 `python3 run_app.py` 即可享受自动端口处理服务！